<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Details - Collaborative Dev Platform</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="../../assets/css/custom.css">
</head>
<body>
  
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="/">
        <i class="bi bi-code-square"></i> DevCollab
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-folder"></i> Projects
            </a>
          </li>
        </ul>
        <div class="d-flex align-items-center">
          <span class="text-white me-3" id="userDisplayName">Loading...</span>
          <button class="btn btn-outline-light btn-sm" id="logoutBtn">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container-fluid mt-4">
    
    <!-- Loading -->
    <div id="loadingSpinner" class="text-center py-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2 text-muted">Loading project...</p>
    </div>

    <!-- Project Content -->
    <div id="projectContent" class="d-none">
      <div class="row">
        <div class="col-md-8">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h2 id="projectName">Project Name</h2>
              <div class="d-flex gap-2 mt-2">
                <span class="badge bg-success" id="projectStatus"></span>
                <span class="badge bg-secondary" id="projectVisibility"></span>
              </div>
            </div>
            <button class="btn btn-outline-primary" onclick="window.location.href='dashboard.html'">
              <i class="bi bi-arrow-left"></i> Back to Projects
            </button>
          </div>

          <!-- Tabs -->
          <ul class="nav nav-tabs" id="projectTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                <i class="bi bi-info-circle"></i> Overview
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="collaborators-tab" data-bs-toggle="tab" data-bs-target="#collaborators" type="button">
                <i class="bi bi-people"></i> Collaborators
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">
                <i class="bi bi-gear"></i> Settings
              </button>
            </li>
          </ul>

          <div class="tab-content mt-3" id="projectTabContent">
            
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5>Description</h5>
                  <p id="projectDescription" class="text-muted"></p>
                  
                  <hr>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <h6>Owner</h6>
                      <p id="projectOwner"></p>
                    </div>
                    <div class="col-md-6">
                      <h6>Created</h6>
                      <p id="projectCreated"></p>
                    </div>
                    <div class="col-md-6">
                      <h6>Last Updated</h6>
                      <p id="projectUpdated"></p>
                    </div>
                    <div class="col-md-6">
                      <h6>Collaborators</h6>
                      <p id="collaboratorCount">0</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Collaborators Tab -->
            <div class="tab-pane fade" id="collaborators" role="tabpanel">
              <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Collaborators</h5>
                  <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#inviteModal" id="inviteBtn">
                    <i class="bi bi-person-plus"></i> Invite
                  </button>
                </div>
                <div class="card-body">
                  <div id="collaboratorsList">
                    <!-- Collaborators will be loaded here -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
              <div class="card shadow-sm mb-3">
                <div class="card-header">
                  <h5 class="mb-0">Project Settings</h5>
                </div>
                <div class="card-body">
                  <form id="updateProjectForm">
                    <div class="mb-3">
                      <label for="settingsName" class="form-label">Project Name</label>
                      <input type="text" class="form-control" id="settingsName" required>
                    </div>
                    <div class="mb-3">
                      <label for="settingsDescription" class="form-label">Description</label>
                      <textarea class="form-control" id="settingsDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                      <label for="settingsVisibility" class="form-label">Visibility</label>
                      <select class="form-select" id="settingsVisibility">
                        <option value="private">Private</option>
                        <option value="shared">Shared</option>
                        <option value="public">Public</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="settingsStatus" class="form-label">Status</label>
                      <select class="form-select" id="settingsStatus">
                        <option value="active">Active</option>
                        <option value="wip">Work in Progress</option>
                        <option value="archived">Archived</option>
                      </select>
                    </div>
                    <button type="submit" class="btn btn-primary" id="saveSettingsBtn">
                      <i class="bi bi-save"></i> Save Changes
                    </button>
                  </form>
                </div>
              </div>

              <!-- Danger Zone -->
              <div class="card shadow-sm border-danger" id="dangerZone">
                <div class="card-header bg-danger text-white">
                  <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Danger Zone</h5>
                </div>
                <div class="card-body">
                  <h6>Delete Project</h6>
                  <p class="text-muted">Once you delete a project, there is no going back. Please be certain.</p>
                  <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="bi bi-trash"></i> Delete This Project
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="bi bi-activity"></i> Quick Actions</h6>
            </div>
            <div class="list-group list-group-flush">
              <a href="#" class="list-group-item list-group-item-action">
                <i class="bi bi-stickies"></i> View Notes
              </a>
              <a href="#" class="list-group-item list-group-item-action">
                <i class="bi bi-ticket"></i> View Tickets
              </a>
              <a href="#" class="list-group-item list-group-item-action">
                <i class="bi bi-gear"></i> Project Rules
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Invite Collaborator Modal -->
  <div class="modal fade" id="inviteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-person-plus"></i> Invite Collaborator</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="inviteForm">
            <div class="mb-3">
              <label for="inviteEmail" class="form-label">Email Address</label>
              <input type="email" class="form-control" id="inviteEmail" required>
            </div>
            <div class="mb-3">
              <label for="inviteRole" class="form-label">Role</label>
              <select class="form-select" id="inviteRole">
                <option value="viewer">Viewer - Can view only</option>
                <option value="editor">Editor - Can edit and manage</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="sendInviteBtn">Send Invite</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Delete Project</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>Are you absolutely sure?</strong></p>
          <p>This action <strong>cannot</strong> be undone. This will permanently delete the project, including:</p>
          <ul>
            <li>All notes and documentation</li>
            <li>All tickets and comments</li>
            <li>All collaborators and permissions</li>
            <li>All project rules and configurations</li>
          </ul>
          <p>Please type <strong id="projectNameConfirm"></strong> to confirm:</p>
          <input type="text" class="form-control" id="deleteConfirmInput" placeholder="Type project name">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
            <i class="bi bi-trash"></i> I understand, delete this project
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Custom JS -->
  <script src="../../assets/js/app.js"></script>
  <script>
    const API_URL = 'http://localhost:3000/api';
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('id');
    let currentProject = null;

    if (!projectId) {
      window.location.href = 'dashboard.html';
    }

    // Check authentication
    document.addEventListener('DOMContentLoaded', () => {
      const user = AppState.getUser();
      if (!user) {
        window.location.href = '../auth/login.html';
        return;
      }

      document.getElementById('userDisplayName').textContent = user.displayName || user.username;
      loadProject();
      loadCollaborators();
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await apiRequest('/auth/logout', { method: 'POST' });
      } catch (error) {
        console.error('Logout error:', error);
      } finally {
        AppState.clearUser();
        window.location.href = '../auth/login.html';
      }
    });

    // Load project details
    async function loadProject() {
      try {
        const data = await apiRequest(`/projects/${projectId}`);
        
        if (data.success) {
          currentProject = data.data.project;
          displayProject(currentProject);
        }
      } catch (error) {
        console.error('Load project error:', error);
        showToast('Failed to load project', 'danger');
        setTimeout(() => window.location.href = 'dashboard.html', 2000);
      } finally {
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('projectContent').classList.remove('d-none');
      }
    }

    // Display project
    function displayProject(project) {
      document.getElementById('projectName').textContent = project.name;
      document.getElementById('projectStatus').textContent = project.status;
      document.getElementById('projectVisibility').textContent = project.visibility;
      document.getElementById('projectDescription').textContent = project.description || 'No description provided';
      document.getElementById('projectOwner').textContent = project.owner_display_name || project.owner_username;
      document.getElementById('projectCreated').textContent = new Date(project.created_at).toLocaleDateString();
      document.getElementById('projectUpdated').textContent = new Date(project.updated_at).toLocaleDateString();
      document.getElementById('collaboratorCount').textContent = project.collaborators ? project.collaborators.length : 0;
      
      // Settings form
      document.getElementById('settingsName').value = project.name;
      document.getElementById('settingsDescription').value = project.description || '';
      document.getElementById('settingsVisibility').value = project.visibility;
      document.getElementById('settingsStatus').value = project.status;
      
      // Delete confirmation
      document.getElementById('projectNameConfirm').textContent = project.name;
      
      // Check if user is owner
      const user = AppState.getUser();
      if (project.owner_id !== user.userId) {
        document.getElementById('dangerZone').style.display = 'none';
        document.getElementById('inviteBtn').style.display = 'none';
      }
    }

    // Load collaborators
    async function loadCollaborators() {
      try {
        const data = await apiRequest(`/collaborators/project/${projectId}`);
        
        if (data.success) {
          displayCollaborators(data.data.collaborators);
        }
      } catch (error) {
        console.error('Load collaborators error:', error);
      }
    }

    // Display collaborators
    function displayCollaborators(collaborators) {
      const list = document.getElementById('collaboratorsList');
      
      if (collaborators.length === 0) {
        list.innerHTML = '<p class="text-muted">No collaborators yet</p>';
        return;
      }

      list.innerHTML = collaborators.map(c => `
        <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
          <div>
            <strong>${c.display_name || c.username}</strong>
            <br>
            <small class="text-muted">${c.email}</small>
            <br>
            <span class="badge bg-${c.role === 'editor' ? 'primary' : 'secondary'}">${c.role}</span>
            ${c.accepted_at ? '<span class="badge bg-success">Accepted</span>' : '<span class="badge bg-warning">Pending</span>'}
          </div>
          ${currentProject && currentProject.owner_id === AppState.getUser().userId ? `
            <button class="btn btn-sm btn-outline-danger" onclick="removeCollaborator('${c.collaboration_id}')">
              <i class="bi bi-trash"></i>
            </button>
          ` : ''}
        </div>
      `).join('');
    }

    // Invite collaborator
    document.getElementById('sendInviteBtn').addEventListener('click', async () => {
      const email = document.getElementById('inviteEmail').value;
      const role = document.getElementById('inviteRole').value;

      try {
        const data = await apiRequest('/collaborators/invite', {
          method: 'POST',
          body: JSON.stringify({ projectId, email, role })
        });

        if (data.success) {
          showToast('Invitation sent successfully!', 'success');
          bootstrap.Modal.getInstance(document.getElementById('inviteModal')).hide();
          document.getElementById('inviteForm').reset();
          loadCollaborators();
        }
      } catch (error) {
        showToast(error.message || 'Failed to send invitation', 'danger');
      }
    });

    // Remove collaborator
    async function removeCollaborator(collaborationId) {
      if (!confirm('Are you sure you want to remove this collaborator?')) return;

      try {
        await apiRequest(`/collaborators/${collaborationId}`, { method: 'DELETE' });
        showToast('Collaborator removed', 'success');
        loadCollaborators();
      } catch (error) {
        showToast('Failed to remove collaborator', 'danger');
      }
    }

    // Update project
    document.getElementById('updateProjectForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('settingsName').value;
      const description = document.getElementById('settingsDescription').value;
      const visibility = document.getElementById('settingsVisibility').value;
      const status = document.getElementById('settingsStatus').value;

      try {
        const data = await apiRequest(`/projects/${projectId}`, {
          method: 'PUT',
          body: JSON.stringify({ name, description, visibility, status })
        });

        if (data.success) {
          showToast('Project updated successfully!', 'success');
          currentProject = data.data.project;
          displayProject(currentProject);
        }
      } catch (error) {
        showToast(error.message || 'Failed to update project', 'danger');
      }
    });

    // Delete confirmation input
    document.getElementById('deleteConfirmInput').addEventListener('input', function() {
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      confirmBtn.disabled = this.value !== currentProject.name;
    });

    // Delete project
    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      try {
        await apiRequest(`/projects/${projectId}`, { method: 'DELETE' });
        showToast('Project deleted successfully', 'success');
        setTimeout(() => window.location.href = 'dashboard.html', 1500);
      } catch (error) {
        showToast('Failed to delete project', 'danger');
      }
    });

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
      toast.style.zIndex = '9999';
      toast.innerHTML = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
